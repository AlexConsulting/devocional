<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="htmlTitle">Devocional para Crian√ßas ‚Äî Dia 1</title>
  <style>
    :root { --bg: #fffaf2; --text: #2b2b2b; --theme: #4a90e2; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); }

    /* NOVO CONTAINER DO SELETOR DE IDIOMAS FLUTUANTE */
    #lang-container {
        position: fixed; 
        top: 15px;
        right: 15px;
        z-index: 100;
    }

    /* BOTAO DE TOGGLE (AGORA COM BANDEIRA DO PA√çS ATUAL) */
    #lang-toggle-btn {
        background: #fff;
        border: 2px solid #ccc;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 0; 
        overflow: hidden; 
    }
    #lang-toggle-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    #lang-toggle-btn:hover {
        border-color: var(--theme, #4a90e2);
    }

    /* DROPDOWN DE IDIOMAS */
    .lang-switch {
        display: none; 
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
        padding: 8px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        align-items: flex-end; 
    }
    .lang-switch.active {
        display: flex; 
    }

    /* BOTOES DE IDIOMA INDIVIDUAIS */
    .lang-switch button { 
      background: #fff; 
      color: #333; 
      border: 2px solid #ccc; 
      border-radius: 50%; 
      padding: 0; 
      width: 36px; 
      height: 36px;
      text-align: center;
      cursor: pointer; 
      transition: all 0.2s ease; 
      margin: 0; 
      display: flex; 
      align-items: center;
      justify-content: center;
      overflow: hidden; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .lang-switch button img {
      width: 100%; 
      height: 100%;
      object-fit: cover; 
      border-radius: 50%; 
    }
    .lang-switch button:hover { 
      border-color: var(--theme, #4a90e2); 
    }
    /* FIM CSS DO SELETOR DE IDIOMAS */

    header { 
        padding: 16px; 
        text-align: center; 
        background: #fff; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        transition: padding 0.3s ease;
    }
    .title { font-size: 1.8rem; margin: 0 0 8px; color: var(--theme); transition: opacity 0.3s ease, transform 0.3s ease, height 0.3s ease, margin 0.3s ease; }
    .subtitle { color: #555; margin: 0 0 16px; transition: opacity 0.3s ease, transform 0.3s ease, height 0.3s ease, margin 0.3s ease; }

    /* ESTILO PARA OCULTAR T√çTULO E SUBT√çTULO AP√ìS ROLAGEM */
    header.scrolled-up {
        padding-top: 8px; /* Reduz o padding para "encolher" o header */
        padding-bottom: 8px;
    }

    header.scrolled-up #mainTitle,
    header.scrolled-up #subtitle {
        opacity: 0;
        height: 0; /* Colapsa a altura */
        margin: 0;
        padding: 0;
        overflow: hidden;
        transform: translateY(-10px);
        pointer-events: none;
    }

    .container { max-width: 880px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.08); padding: 16px; margin-bottom: 20px; }

    /* Esconde o bloco de texto do devocional */
    #devocional { display: none; }
    
    /* ********************************************************** */
    /* ESTILOS DO MODO DE COLORIR (AJUSTADO) */
    /* ********************************************************** */

    #coloring-mode {
        display: none; /* Inicia oculto */
        flex-direction: column;
        align-items: center;
        margin-top: 16px;
        
        padding: 10px; 
        max-width: 256px; 
        
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 6px 24px rgba(0,0,0,0.08);
        
        margin-left: auto;
        margin-right: auto;
    }
    
    #coloring-mode.active {
        display: flex;
    }
    
    /* Wrapper para o Canvas: Define a √°rea vis√≠vel e o scroll */
    #canvas-wrapper {
        /* PROPRIEDADES AJUSTADAS PARA O SCROLL E DIMENSIONAMENTO */
        overflow: auto; 
        max-width: 100%;
        /* Altura m√°xima para permitir rolagem vertical (opcional) */
        max-height: 400px; 
        
        margin-bottom: 10px;
        display: flex; 
        justify-content: center; 
        align-items: center;
        
        border: 2px solid #ccc;
        border-radius: 8px;
    }
    
    /* Estilos do Canvas */
    #coloring-canvas {
        /* GARANTE QUE O CANVAS NUNCA EXCEDA O TAMANHO DO PAI ANTES DO ZOOM */
        max-width: 100%; 
        height: auto;
        display: block; 
        cursor: crosshair; 
        
        /* Reset de transform padr√£o, a ser controlado pelo JS */
        transform: scale(1);
        transform-origin: top left;
    }
    
    #color-palette {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 16px;
        justify-content: center;
        padding: 10px;
        background: #f7f7f7;
        border-radius: 8px;
        max-width: 100%;
    }
    
    .color-swatch {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: transform 0.1s ease, border-color 0.2s ease;
    }
    
    .color-swatch.active {
        transform: scale(1.15);
        border-color: #333;
    }
    
    /* ********************************************************** */
    /* FIM ESTILOS DO MODO DE COLORIR */
    /* ********************************************************** */


    .gender-switch { margin: 12px 0; text-align: center; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    header.scrolled-up .gender-switch { margin-top: 0; }
    
    .gender-switch button { 
      border-radius: 999px; padding: 10px 16px; font-weight: 600; cursor: pointer; font-size: 1rem; 
      background: transparent;
      border: 2px solid;
      color: var(--text); 
      transition: all 0.2s ease;
    }
    .gender-switch button[onclick="setGender('boy')"] { border-color: #4a90e2; }
    .gender-switch button[onclick="setGender('girl')"] { border-color: #e75480; }
    .gender-switch button.active-boy { background: #4a90e2; border-color: #4a90e2; color: #fff; }
    .gender-switch button.active-girl { background: #e75480; border-color: #e75480; color: #fff; }

    .audio { display: flex; align-items: center; gap: 12px; justify-content: center; margin: 12px 0 20px; }
    header.scrolled-up .audio { margin-top: 8px; }
    
    /* Estilo Outline Cinza Escuro para bot√µes de √°udio e a√ß√£o */
    .audio button, .link-btn {
        border: 2px solid #555; 
        background: transparent;
        color: #555; 
        border-radius: 999px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s ease;
    }
    
    /* Regra 1: Hover padr√£o (azul/rosa s√≥lido) */
    .audio button:hover, .link-btn:hover { 
        background: var(--theme);
        border-color: var(--theme);
        color: #fff;
    }
    
    /* Regra 2: Hover neutro (cinza claro) - Estado inicial */
    /* Garante que o hover neutro se aplique aos bot√µes de a√ß√£o e √°udio no estado inicial */
    .neutral-hover .audio button:hover, 
    .neutral-hover .link-btn:hover,
    .neutral-hover .stop-btn:hover {
        background: #f0f0f0 !important; /* !important para sobrescrever o estilo do stop-btn */
        border-color: #555 !important; 
        color: #2b2b2b !important; 
    }
    
    /* Estilo para bot√µes desabilitados */
    .audio button[disabled], .link-btn[disabled], .stop-btn[disabled] {
        cursor: not-allowed !important;
        opacity: 0.5;
        background: transparent !important;
        color: #555 !important;
        border-color: #555 !important;
        pointer-events: none; 
    }

    /* O stop-btn usa borda e cor de fundo */
    .stop-btn { background: #f44336; color: #fff; border: 2px solid #f44336; border-radius: 999px; padding: 10px 16px;
      font-weight: 600; cursor: pointer; font-size: 1rem; transition: background 0.2s ease; }
    
    body:not(.neutral-hover) .stop-btn:hover { 
        background: #d32f2f; border-color: #d32f2f; 
    }

    /* Centraliza a √∫nica imagem */
    #imagesSection { 
      /* OCULTA no estado neutro (ser√° alterado para 'flex' em setGender) */
      display: none;
      justify-content: center; 
      margin-top: 16px; 
    }
    header.scrolled-up #imagesSection { margin-top: 8px; }

    figure { 
      margin: 0; 
      background: #f7f7f7; 
      border-radius: 12px; 
      padding: 10px; 
      text-align: center; 
      border: 2px solid var(--theme); 
      max-width: 256px; 
      width: 100%; 
    }
    img { 
      width: 100%; 
      height: auto; 
      border-radius: 8px; 
      display: block; 
      margin: 0 auto; 
    }
    figcaption { font-size: 0.9rem; color: #666; margin-top: 6px; }

    .buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 24px; justify-content: center; }

    body.boy { --theme: #4a90e2; }
    body.girl { --theme: #e75480; }


    /* ********************************************************** */
    /* AJUSTES PARA MOBILE (Media Query) */
    /* ********************************************************** */
    @media (max-width: 600px) {
        /* 1. T√≠tulo principal */
        .title {
            font-size: 1.5rem; 
            margin-bottom: 4px;
        }

        /* 2. Subt√≠tulo */
        .subtitle {
            margin-top: 4px; 
            margin-bottom: 12px;
        }

        /* 3. Bandeira de Idiomas (Toggle) */
        #lang-container {
            top: 8px; 
            right: 8px; 
        }
        #lang-toggle-btn {
            width: 36px; 
            height: 36px; 
        }
        
        /* 4. Bot√µes de G√™nero */
        .gender-switch button {
            padding: 8px 14px; 
            font-size: 0.95rem; 
        }
        
        /* 5. Bot√µes de A√ß√£o (Imprimir, Colorir, Pr√≥ximo) */
        .buttons {
            flex-direction: column;
            align-items: center;
        }
    }
    /* ********************************************************** */


  </style>
</head>
<body class="boy neutral-hover">
  <div id="lang-container">
    <button id="lang-toggle-btn" title="Selecionar Idioma" onclick="toggleLangSwitch()">
        <img id="current-lang-flag" src="https://flagicons.lipis.dev/flags/4x3/br.svg" alt="Bandeira do Brasil">
    </button>
    <div class="lang-switch">
      <button onclick="setLang('pt')" title="Portugu√™s"><img src="https://flagicons.lipis.dev/flags/4x3/br.svg" alt="Bandeira do Brasil"></button>
      <button onclick="setLang('en')" title="English"><img src="https://flagicons.lipis.dev/flags/4x3/us.svg" alt="US Flag"></button>
      <button onclick="setLang('es')" title="Espa√±ol"><img src="https://flagicons.lipis.dev/flags/4x3/es.svg" alt="Bandera de Espa√±a"></button>
      <button onclick="setLang('fr')" title="Fran√ßais"><img src="https://flagicons.lipis.dev/flags/4x3/fr.svg" alt="Drapeau de la France"></button>
    </div>
  </div>

  <header id="mainHeader">
    <h1 id="mainTitle" class="title">Devocional Infantil</h1>
    <p id="subtitle" class="subtitle"></p>

    <div class="gender-switch">
      <button id="btnBoy" onclick="setGender('boy')">üë¶ Sou Menino</button>
      <button id="btnGirl" onclick="setGender('girl')">üëß Sou Menina</button>
    </div>

    <div class="audio">
      <button id="playBtn" class="link-btn" disabled>‚ñ∂Ô∏è Ouvir Devocional</button>
      <button id="speedBtn" disabled>Velocidade: 1.00x</button>
      <button id="stopBtn" class="stop-btn" disabled>‚èπÔ∏è Parar</button>
    </div>

    <section id="imagesSection" class="images">
      <figure><img id="imgColorSrc" src="" alt="" /><figcaption id="captionColor"></figcaption></figure>
    </section>
  </header>

  <main class="container">
    <div id="devocional" class="card"></div>
    
    <div id="coloring-mode" class="card">
        <h3>üé® √â hora de Colorir!</h3>
        
        <div id="canvas-wrapper">
            <canvas id="coloring-canvas"></canvas>
        </div>
        
        <div id="color-palette">
            </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button id="zoomBtn" class="link-btn">üîç Zoom: 1.0x</button>
            <button id="closeColoringBtn" class="stop-btn">‚ùå Fechar Modo Colorir</button>
        </div>
    </div>
    
    <div class="buttons">
      <a id="coloringBtn" class="link-btn" onclick="toggleColoringMode(true)" disabled>üé® Colorir Digitalmente</a>
      <a id="printBtn" class="link-btn" href="" target="_blank" disabled>Imprimir</a>
      <a id="nextBtn" class="link-btn" href="/devocionais/dia-2.html" onclick="saveProgress()">Pr√≥ximo devocional</a>
    </div>
  </main>

  <script>
    // Estado
    let currentLang = 'pt';
    let currentGender = 'boy';
    let speedIdx = 0; 
    const speeds = [1.0, 1.15, 1.3]; 

    // Refer√™ncias do App
    const htmlTitleEl = document.getElementById('htmlTitle');
    const mainTitleEl = document.getElementById('mainTitle');
    const playBtn = document.getElementById('playBtn'); 
    const speedBtn = document.getElementById('speedBtn');
    const stopBtn = document.getElementById('stopBtn');
    const devBox = document.getElementById('devocional');
    const subtitleEl = document.getElementById('subtitle');
    const printBtn = document.getElementById('printBtn');
    const nextBtn = document.getElementById('nextBtn');
    const captionColor = document.getElementById('captionColor');
    const imgColorSrc = document.getElementById('imgColorSrc');
    const btnBoy = document.getElementById('btnBoy');
    const btnGirl = document.getElementById('btnGirl');
    const imagesSection = document.getElementById('imagesSection'); 
    const langSwitchEl = document.querySelector('.lang-switch');
    const currentLangFlagEl = document.getElementById('current-lang-flag');
    const mainHeader = document.getElementById('mainHeader');

    // Refer√™ncias do Modo Colorir
    const coloringModeEl = document.getElementById('coloring-mode');
    const coloringCanvas = document.getElementById('coloring-canvas');
    const colorPaletteEl = document.getElementById('color-palette');
    const coloringBtn = document.getElementById('coloringBtn');
    const closeColoringBtn = document.getElementById('closeColoringBtn');
    const canvasWrapper = document.getElementById('canvas-wrapper'); 
    const zoomBtn = document.getElementById('zoomBtn'); 
    
    // Adicionamos { willReadFrequently: true } para otimizar o getImageData
    const ctx = coloringCanvas.getContext('2d', { willReadFrequently: true }); 
    
    let isColoringMode = false;
    let selectedColor = '#FF0000'; // Cor inicial: Vermelho
    let currentColoringPath = ''; // Armazena o caminho da imagem P&B atual
    
    // Vari√°veis do Zoom
    const zoomLevels = [1.0, 1.5, 2.0, 3.0]; // N√≠veis de zoom
    let zoomIdx = 0;
    let currentZoom = zoomLevels[0];

    // Paleta de cores para o modo de colorir
    const COLORS = [
        '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', 
        '#FF8000', '#8000FF', '#008000', '#800000', 
        '#FFC0CB', '#ADD8E6', '#90EE90', '#F4A460', 
        '#A52A2A', '#808080', '#000000', '#FFFFFF'  
    ];
    
    // **********************************************************
    // L√≥gica de Progresso (NOVA)
    // **********************************************************
    const STORAGE_KEY = 'dev_babys';
    // Se o arquivo atual √© o Dia 1, o pr√≥ximo dia √© o Dia 2.
    const CURRENT_DEVOTIONAL_DAY = 1; 
    const NEXT_DEVOTIONAL_DAY = 2; 

    function saveProgress() {
        if (typeof localStorage !== 'undefined') {
            // Salva o n√∫mero do pr√≥ximo dia a ser feito.
            localStorage.setItem(STORAGE_KEY, NEXT_DEVOTIONAL_DAY.toString());
            console.log(`Progresso salvo para ${STORAGE_KEY}: Pr√≥ximo dia √© ${NEXT_DEVOTIONAL_DAY}`);
        }
    }
    
    function checkAndRedirect() {
        if (typeof localStorage !== 'undefined') {
            const savedDay = parseInt(localStorage.getItem(STORAGE_KEY));
            
            // Verifica se o progresso indica um dia posterior
            if (!isNaN(savedDay) && savedDay > CURRENT_DEVOCIONAL_DAY) {
                const targetHref = `/devocionais/dia-${savedDay}.html`;
                
                // Atualiza o link do bot√£o "Pr√≥ximo Devocional" para o dia correto.
                nextBtn.href = targetHref;
                
                console.log(`Progresso encontrado: Ajustando link para o Dia ${savedDay} (${targetHref})`);
            } else {
                 console.log(`Progresso n√£o encontrado ou est√° no dia correto (${CURRENT_DEVOTIONAL_DAY}).`);
            }
        }
    }
    // **********************************************************
    // FIM L√≥gica de Progresso
    // **********************************************************


    // Fun√ß√µes de UI
    function toggleLangSwitch() {
        langSwitchEl.classList.toggle('active');
    }

    // Fun√ß√µes do Modo Colorir
    
    function hexToRgba(hex) {
        const bigint = parseInt(hex.slice(1), 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r, g, b, 255]; // Adiciona 255 para o canal alfa
    }

    function matchColor(data, index, color, tolerance = 32) {
        // Verifica se a cor do pixel (r, g, b) est√° dentro da toler√¢ncia da cor alvo (r, g, b, a)
        return (
            Math.abs(data[index] - color[0]) <= tolerance &&
            Math.abs(data[index + 1] - color[1]) <= tolerance &&
            Math.abs(data[index + 2] - color[2]) <= tolerance &&
            Math.abs(data[index + 3] - color[3]) <= tolerance // Verifica o canal Alpha
        );
    }
    
    // IMPLEMENTA√á√ÉO SIMPLIFICADA E SINCRONA DO ALGORITMO FLOOD FILL (BALDE DE TINTA)
    function floodFill(startX, startY, newColorHex) {
        if (!currentColoringPath) return;

        const { width, height } = coloringCanvas;
        try {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // Converte as cores para formato RGBA [R, G, B, A]
            const newColor = hexToRgba(newColorHex);
            const targetIndex = (startY * width + startX) * 4;
            const targetColor = [
                data[targetIndex],
                data[targetIndex + 1],
                data[targetIndex + 2],
                data[targetIndex + 3] 
            ];

            // Se a nova cor for a mesma cor alvo, n√£o faz nada
            if (targetColor.every((c, i) => c === newColor[i])) {
                return;
            }
            
            // Toler√¢ncia de cor (√∫til para lidar com bordas anti-aliasing)
            const TOLERANCE = 30;

            // Implementa√ß√£o Stack-based (mais eficiente que recursiva)
            const pixelStack = [[startX, startY]];

            while (pixelStack.length) {
                let [x, y] = pixelStack.pop();
                let index = (y * width + x) * 4;

                // Se o pixel atual n√£o for a cor alvo (dentro da toler√¢ncia), pula ele 
                if (!matchColor(data, index, targetColor, TOLERANCE)) {
                    continue;
                }
                
                // Preenche o pixel com a nova cor
                data[index] = newColor[0];
                data[index + 1] = newColor[1];
                data[index + 2] = newColor[2];
                data[index + 3] = newColor[3];

                // Adiciona vizinhos √† pilha para verifica√ß√£o (dentro dos limites do canvas)
                if (x > 0) pixelStack.push([x - 1, y]);
                if (x < width - 1) pixelStack.push([x + 1, y]);
                if (y > 0) pixelStack.push([x, y - 1]);
                if (y < height - 1) pixelStack.push([x, y + 1]);
            }
            
            // Desenha a imagem modificada de volta no canvas
            ctx.putImageData(imageData, 0, 0);

        } catch (e) {
            console.error('ERRO de seguran√ßa/tinta no Canvas:', e);
            alert('ERRO: Falha ao tentar colorir (restri√ß√£o de seguran√ßa do navegador). Se estiver executando localmente (file:///), use um servidor web simples ou verifique se a imagem P&B carregou corretamente.');
        }
    }

    // Fun√ß√£o para alternar o n√≠vel de zoom (AJUSTADA)
    function toggleZoom() {
        // Cicla entre os n√≠veis de zoom
        zoomIdx = (zoomIdx + 1) % zoomLevels.length;
        currentZoom = zoomLevels[zoomIdx];
        
        // Aplica o zoom diretamente no CANVAS
        coloringCanvas.style.transformOrigin = 'top left'; 
        coloringCanvas.style.transform = `scale(${currentZoom})`;
        
        zoomBtn.textContent = `üîç Zoom: ${currentZoom.toFixed(1)}x`;
        
        // Ajusta o tamanho do wrapper para o tamanho escalado do canvas
        if (currentZoom > 1.0) {
            // O tamanho do wrapper agora reflete o tamanho escalado do canvas, permitindo o scroll
            canvasWrapper.style.width = `${coloringCanvas.width * currentZoom}px`;
            canvasWrapper.style.height = `${coloringCanvas.height * currentZoom}px`;
            canvasWrapper.style.overflow = 'auto'; // Habilita o scroll
        } else {
            // Volta ao tamanho original (com limites max-width/max-height definidos no CSS)
            canvasWrapper.style.width = '100%'; 
            canvasWrapper.style.height = 'auto'; 
            canvasWrapper.style.overflow = 'hidden'; // Desabilita o scroll quando n√£o h√° zoom
        }
    }

    // Manipulador de clique no canvas
    function handleColoringClick(event) {
        if (!isColoringMode) return;

        const rect = coloringCanvas.getBoundingClientRect();
        
        let clientX, clientY;
        if (event.touches && event.touches.length > 0) {
            clientX = event.touches[0].clientX;
            clientY = event.touches[0].clientY;
        } else {
            clientX = event.clientX;
            clientY = event.clientY;
        }
        
        const x_visual = clientX - rect.left;
        const y_visual = clientY - rect.top;
        
        // A escala real de pixels do canvas (canvas.width / rect.width)
        const scaleX = coloringCanvas.width / rect.width;
        const scaleY = coloringCanvas.height / rect.height;
        
        // Coordenadas do pixel no canvas INTERNO (ajustadas pela escala visual e pelo zoom)
        // Usa o currentZoom para reverter o efeito da transforma√ß√£o CSS
        const x_original = Math.floor(x_visual * scaleX / currentZoom);
        const y_original = Math.floor(y_visual * scaleY / currentZoom);
        
        const x = Math.min(Math.max(0, x_original), coloringCanvas.width - 1);
        const y = Math.min(Math.max(0, y_original), coloringCanvas.height - 1);
        
        floodFill(x, y, selectedColor);
    }


    // Define a cor selecionada (chamado ao clicar nos swatches)
    function setColor(color, element) {
        selectedColor = color;
        // Atualiza o estado visual da paleta
        document.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('active'));
        element.classList.add('active');
    }
    
    // Cria a paleta de cores no HTML
    function createColorPalette() {
        colorPaletteEl.innerHTML = '';
        COLORS.forEach((color, index) => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = color;
            swatch.onclick = () => setColor(color, swatch);
            if (index === 0) {
                swatch.classList.add('active');
                selectedColor = color; 
            }
            colorPaletteEl.appendChild(swatch);
        });
    }

    // Carrega a imagem P&B no canvas e prepara para colorir (AJUSTADA)
    function initColoringMode() {
        const imagePath = content[currentLang].images[currentGender].bw;
        
        if (!imagePath) return;

        // Se a imagem P&B j√° est√° carregada no canvas (para evitar recarregar)
        if (imagePath === currentColoringPath && coloringCanvas.width > 0) {
            // Garante que o estado visual do zoom seja redefinido ao reabrir o modo
            if (currentZoom !== 1.0) {
                toggleZoom(); // Reseta para 1.0x
            }
            return;
        }

        currentColoringPath = imagePath;
        const img = new Image();
        img.crossOrigin = 'Anonymous'; 
        
        img.onload = function() {
            // Define o tamanho nativo do canvas para a imagem
            coloringCanvas.width = img.naturalWidth;
            coloringCanvas.height = img.naturalHeight;
            
            // Desenha a imagem P&B
            ctx.drawImage(img, 0, 0);
            
            // Reseta o zoom para 1.0x e ajusta o wrapper
            zoomIdx = 0;
            currentZoom = zoomLevels[0];
            coloringCanvas.style.transform = `scale(1.0)`; // Aplica o reset diretamente no canvas
            canvasWrapper.style.width = '100%'; 
            canvasWrapper.style.height = 'auto'; 
            canvasWrapper.style.overflow = 'hidden'; // Esconde o scrollbar inicialmente
            zoomBtn.textContent = `üîç Zoom: 1.0x`;
        };
        
        img.onerror = function() {
            console.error('ERRO: A imagem P&B para colorir n√£o foi carregada. Verifique se o arquivo existe em:', imagePath);
            alert('ERRO: A imagem para colorir n√£o foi encontrada. Verifique se o arquivo est√° na pasta correta: ' + imagePath);
            toggleColoringMode(false); 
        };

        img.src = imagePath; 
    }

    // Alterna entre o modo Devocional e o Modo Colorir
    function toggleColoringMode(activate) {
        isColoringMode = activate;
        
        if (activate) {
            // Entra no modo colorir: esconde devocional e imagem colorida
            devBox.style.display = 'none';
            imagesSection.style.display = 'none'; 
            coloringModeEl.classList.add('active');
            
            // Rola para o topo do modo colorir para visualiza√ß√£o
            coloringModeEl.scrollIntoView({ behavior: 'smooth' });
            
            // Garante que o header fique encolhido
            mainHeader.classList.add('scrolled-up');
            
            initColoringMode();
        } else {
            // Sai do modo colorir: Garante que a imagem colorida esteja vis√≠vel se o g√™nero foi selecionado
            coloringModeEl.classList.remove('active');
            
            if (!document.body.classList.contains('neutral-hover')) {
                imagesSection.style.display = 'flex';
            } else {
                imagesSection.style.display = 'none';
            }
            
            // Reseta o zoom ao fechar
            if (currentZoom !== 1.0) {
                if (zoomBtn && !zoomBtn.disabled) {
                    toggleZoom();
                } else {
                    zoomIdx = 0;
                    currentZoom = zoomLevels[0];
                }
            }

            // LIMPA O CANVAS ao fechar
            ctx.clearRect(0, 0, coloringCanvas.width, coloringCanvas.height);
            currentColoringPath = ''; // For√ßa o recarregamento na pr√≥xima vez
        }
    }
    
    // Adiciona o manipulador de clique ao canvas
    coloringCanvas.addEventListener('mousedown', handleColoringClick);
    coloringCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault(); // Previne o zoom ou rolagem do mobile
        if (e.touches && e.touches.length > 0) {
            handleColoringClick({ 
                clientX: e.touches[0].clientX, 
                clientY: e.touches[0].clientY,
                target: coloringCanvas 
            });
        }
    });
    
    // Adiciona o manipulador de clique ao bot√£o de fechar
    closeColoringBtn.addEventListener('click', () => toggleColoringMode(false));
    
    // Adiciona o manipulador de clique ao bot√£o de zoom
    zoomBtn.addEventListener('click', toggleZoom);

    // CAMINHOS DE IMAGEM UNIFICADOS (RELATIVOS)
    const BOY_COLOR_IMG = './img/dia-1/boy.png'; 
    const GIRL_COLOR_IMG = './img/dia-1/girl.png'; 
    // Caminhos P&B corrigidos (confirmados pelo usu√°rio)
    const BOY_BW_IMG = './img/dia-1/color/color_boy.png'; 
    const GIRL_BW_IMG = './img/dia-1/color/color_girl.png'; 
    const BOY_PRINT_PDF = './print/dia-1/menino_para_colorir.pdf';
    const GIRL_PRINT_PDF = './print/dia-1/menina_para_colorir.pdf';


    // Conte√∫do por idioma e g√™nero (Completo com PT, EN, ES, FR)
    const content = {
      pt: {
        header: {
            mainTitle: 'Devocional para Crian√ßas',
            htmlTitle: 'Devocional para Crian√ßas ‚Äî Dia 1',
            play: '‚ñ∂Ô∏è Ouvir Devocional',
            speed: 'Velocidade',
            stop: '‚èπÔ∏è Parar',
        },
        boy: {
          title: 'Dia 1 ‚Äî O Presente √önico de Deus',
          html: `
            <h3>Vers√≠culo Chave</h3>
            <p><strong>G√°latas 1:8-9 (NTLH):</strong> ‚ÄúMas que fiquem debaixo da maldi√ß√£o de Deus todos aqueles que anunciem uma mensagem diferente da que n√≥s anunciamos.‚Äù</p>
            <h3>Resumo</h3>
            <p>Existe s√≥ uma not√≠cia incr√≠vel sobre como ficamos amigos de Deus: a salva√ß√£o √© um presente que Jesus nos d√°. N√£o √© um trof√©u que a gente ganha fazendo tudo certo ou obedecendo um monte de regras. √â s√≥ pela gra√ßa de Deus ‚Äî o presente mais valioso que existe.</p>
            <h3>Aplica√ß√£o Pr√°tica</h3>
            <p>Voc√™ j√° pensou que precisa ser o melhor, obedecer sempre, ou nunca errar para Deus gostar mais de voc√™? N√£o precisa! Jesus j√° fez tudo por voc√™. Agrade√ßa e confie: o amor dEle n√£o depende do seu desempenho.</p>
            <h3>Ora√ß√£o</h3>
            <p>‚ÄúQuerido Deus, obrigado porque a salva√ß√£o √© um presente de Jesus. Me ajuda a lembrar que o Senhor me ama mesmo quando eu erro. E que minhas boas a√ß√µes n√£o compram o Teu amor. Am√©m!‚Äù</p>
          `
        },
        girl: {
          title: 'Dia 1 ‚Äî O Presente √önico de Deus',
          html: `
            <h3>Vers√≠culo Chave</h3>
            <p><strong>G√°latas 1:8-9 (NTLH):</strong> ‚ÄúMas que fiquem debaixo da maldi√ß√£o de Deus todos aqueles que anunciem uma mensagem diferente da que n√≥s anunciamos.‚Äù</p>
            <h3>Resumo</h3>
            <p>Existe s√≥ uma not√≠cia maravilhosa sobre como ficamos amigas de Deus: a salva√ß√£o √© um presente que Jesus nos d√°. N√£o √© uma medalha para quem faz tudo certinho. √â s√≥ a gra√ßa dEle ‚Äî um presente de amor que n√£o d√° pra trocar, completar ou melhorar.</p>
            <h3>Aplica√ß√£o Pr√°tica</h3>
            <p>√Äs vezes voc√™ pode achar que precisa ser perfeita, nunca errar ou sempre agradar todo mundo para Deus te amar. Mas o amor de Jesus j√° √© completo, do jeitinho que voc√™ √©. Voc√™ pode descansar nisso: Jesus j√° fez tudo o que voc√™ precisa.</p>
            <h3>Ora√ß√£o</h3>
            <p>‚ÄúQuerido Deus, obrigada porque a salva√ß√£o √© um presente de Jesus. Me ajuda a lembrar que o Senhor me ama at√© quando eu erro. E que minhas boas a√ß√µes n√£o compram o Teu amor. Am√©m!‚Äù</p>
          `
        },
        captions: { color: 'Presente de Deus', bw: 'Para colorir' },
        buttons: {
          printBoy: 'Imprimir Desenho (Menino)',
          printGirl: 'Imprimir Desenho (Menina)',
          coloring: 'üé® Colorir Digitalmente',
          next: 'Pr√≥ximo devocional',
          boy: 'üë¶ Sou Menino',
          girl: 'üëß Sou Menina'
        },
        images: {
          boy: { color: BOY_COLOR_IMG, bw: BOY_BW_IMG }, 
          girl: { color: GIRL_COLOR_IMG, bw: GIRL_BW_IMG } 
        },
        print: { boy: BOY_PRINT_PDF, girl: GIRL_PRINT_PDF }
      },
      en: { 
        header: {
            mainTitle: 'Devotional for Children',
            htmlTitle: 'Devotional for Children ‚Äî Day 1',
            play: '‚ñ∂Ô∏è Listen to Devotional',
            speed: 'Speed',
            stop: '‚èπÔ∏è Stop',
        },
        boy: { 
          title: "Day 1 ‚Äî God‚Äôs Unique Gift", 
          html: `
            <h3>Key Verse</h3>
            <p><strong>Galatians 1:8-9 (NIV):</strong> ‚ÄúBut even if we or an angel from heaven should preach a gospel other than the one we preached to you, let them be under God‚Äôs curse!‚Äù</p>
            <h3>Summary</h3>
            <p>There is only one incredible news about how we become friends with God: salvation is a gift that Jesus gives us. It is not a trophy that we win by doing everything right or obeying a lot of rules. It is only by God's grace‚Äîthe most valuable gift there is.</p>
            <h3>Practical Application</h3>
            <p>Have you ever thought you need to be the best, always obey, or never make a mistake for God to like you more? You don't need to! Jesus has already done everything for you. Be thankful and trust: His love doesn't depend on your performance.</p>
            <h3>Prayer</h3>
            <p>‚ÄúDear God, thank you that salvation is a gift from Jesus. Help me remember that You love me even when I make mistakes. And that my good deeds do not buy Your love. Amen!‚Äù</p>
          `
        },
        girl: { 
          title: "Day 1 ‚Äî God‚Äôs Unique Gift", 
          html: `
            <h3>Key Verse</h3>
            <p><strong>Galatians 1:8-9 (NIV):</strong> ‚ÄúBut even if we or an angel from heaven should preach a gospel other than the one we preached to you, let them be under God‚Äôs curse!‚Äù</p>
            <h3>Summary</h3>
            <p>There is only one wonderful news about how we become friends with God: salvation is a gift that Jesus gives us. It is not a medal for those who do everything right. It is just His grace‚Äîa gift of love that cannot be exchanged, completed, or improved.</p>
            <h3>Practical Application</h3>
            <p>Sometimes you might think you need to be perfect, never make a mistake, or always please everyone for God to love you. But Jesus' love is already complete, just the way you are. You can rest in this: Jesus has already done everything you need.</p>
            <h3>Prayer</h3>
            <p>‚ÄúDear God, thank you that salvation is a gift from Jesus. Help me remember that You love me even when I make mistakes. And that my good deeds do not buy Your love. Amen!‚Äù</p>
          ` 
        },
        captions: { color: 'Gift from God', bw: 'Coloring page' },
        buttons: {
          printBoy: 'Print Coloring Page (Boy)',
          printGirl: 'Print Coloring Page (Girl)',
          coloring: 'üé® Color Digitally',
          next: 'Next devotional',
          boy: 'üë¶ I am a Boy',
          girl: 'üëß I am a Girl'
        },
        images: {
          boy: { color: BOY_COLOR_IMG, bw: BOY_BW_IMG }, 
          girl: { color: GIRL_COLOR_IMG, bw: GIRL_BW_IMG } 
        },
        print: { boy: BOY_PRINT_PDF, girl: GIRL_PRINT_PDF }
      },
      es: { 
        header: {
            mainTitle: 'Devocional para Ni√±os',
            htmlTitle: 'Devocional para Ni√±os ‚Äî D√≠a 1',
            play: '‚ñ∂Ô∏è Escuchar Devocional',
            speed: 'Velocidad',
            stop: '‚èπÔ∏è Parar',
        },
        boy: { 
          title: 'D√≠a 1 ‚Äî El Regalo √önico de Dios', 
          html: `
            <h3>Vers√≠culo Clave</h3>
            <p><strong>G√°latas 1:8-9 (NVI):</strong> ‚ÄúPero si aun nosotros, o un √°ngel del cielo, les anunciamos un evangelio diferente del que les hemos anunciado, ¬°sea anatema!‚Äù</p>
            <h3>Resumen</h3>
            <p>Solo hay una noticia incre√≠ble sobre c√≥mo nos hacemos amigos de Dios: la salvaci√≥n es un regalo que Jes√∫s nos da. No es un trofeo que ganamos haciendo todo bien u obedeciendo un mont√≥n de reglas. Es solo por la gracia de Dios, el regalo m√°s valioso que existe.</p>
            <h3>Aplicaci√≥n Pr√°ctica</h3>
            <p>¬øAlguna vez pensaste que necesitas ser el mejor, obedecer siempre o nunca equivocarte para que le gustes m√°s a Dios? ¬°No es necesario! Jes√∫s ya hizo todo por ti. Agradece y conf√≠a: Su amor no depende de tu desempe√±o.</p>
            <h3>Oraci√≥n</h3>
            <p>‚ÄúQuerido Dios, gracias porque la salvaci√≥n es un regalo de Jes√∫s. Ay√∫dame a recordar que me amas incluso cuando me equivoco. Y que mis buenas acciones no compran Tu amor. ¬°Am√©n!‚Äù</p>
          ` 
        },
        girl: { 
          title: 'D√≠a 1 ‚Äî El Regalo √önico de Dios', 
          html: `
            <h3>Vers√≠culo Clave</h3>
            <p><strong>G√°latas 1:8-9 (NVI):</strong> ‚ÄúPero si aun nosotros, o un √°ngel del cielo, les anunciamos un evangelio diferente del que les hemos anunciado, ¬°sea anatema!‚Äù</p>
            <h3>Resumen</h3>
            <p>Solo hay una noticia maravillosa sobre c√≥mo nos hacemos amigas de Dios: la salvaci√≥n es un regalo que Jes√∫s nos da. No es una medalla para quien hace todo correctamente. Es solo Su gracia, un regalo de amor que no se puede cambiar, completar ni mejorar.</p>
            <h3>Aplicaci√≥n Pr√°ctica</h3>
            <p>A veces puedes pensar que necesitas ser perfecta, nunca equivocarte o agradar a todos para que Dios te ame. Pero el amor de Jes√∫s ya es completo, tal como eres. Puedes descansar en esto: Jes√∫s ya hizo todo lo que necesitas.</p>
            <h3>Oraci√≥n</h3>
            <p>‚ÄúQuerido Dios, gracias porque la salvaci√≥n es un regalo de Jes√∫s. Ay√∫dame a recordar que me amas incluso cuando me equivoco. Y que mis buenas acciones no compran Tu amor. ¬°Am√©n!‚Äù</p>
          ` 
        },
        captions: { color: 'Regalo de Dios', bw: 'P√°gina para colorear' },
        buttons: {
          printBoy: 'Imprimir dibujo (Ni√±o)',
          printGirl: 'Imprimir dibujo (Ni√±a)',
          coloring: 'üé® Colorear Digitalmente',
          next: 'Siguiente devocional',
          boy: 'üë¶ Soy Ni√±o',
          girl: 'üëß Soy Ni√±a'
        },
        images: {
          boy: { color: BOY_COLOR_IMG, bw: BOY_BW_IMG }, 
          girl: { color: GIRL_COLOR_IMG, bw: GIRL_BW_IMG } 
        },
        print: { boy: BOY_PRINT_PDF, girl: GIRL_PRINT_PDF }
      },
      fr: { 
        header: {
            mainTitle: 'D√©votion pour Enfants',
            htmlTitle: 'D√©votion pour Enfants ‚Äî Jour 1',
            play: '‚ñ∂Ô∏è √âcouter la D√©votion',
            speed: 'Vitesse',
            stop: '‚èπÔ∏è Arr√™ter',
        },
        boy: { 
          title: 'Jour 1 ‚Äî Le Cadeau Unique de Dieu', 
          html: `
            <h3>Verset Cl√©</h3>
            <p><strong>Galates 1:8-9 (LSG):</strong> ‚ÄúMais si nous-m√™mes, ou un ange du ciel, vous annon√ßait un √âvangile s‚Äô√©cartant de celui que nous vous avons annonc√©, qu‚Äôil soit anath√®me !‚Äù</p>
            <h3>R√©sum√©</h3>
            <p>Il n'y a qu'une seule nouvelle incroyable sur la fa√ßon dont nous devenons amis avec Dieu : le salut est un cadeau que J√©sus nous offre. Ce n'est pas un troph√©e que l'on gagne en faisant tout bien ou en ob√©issant √† beaucoup de r√®gles. C'est uniquement par la gr√¢ce de Dieu, le cadeau le plus pr√©cieux qui soit.</p>
            <h3>Application Pratique</h3>
            <p>As-tu d√©j√† pens√© que tu devais √™tre le meilleur, ob√©ir toujours, ou ne jamais te tromper pour que Dieu t'aime davantage ? Ce n'est pas n√©cessaire ! J√©sus a d√©j√† tout fait pour toi. Remercie et aie confiance : Son amour ne d√©pend pas de tes performances.</p>
            <h3>Pri√®re</h3>
            <p>‚ÄúCher Dieu, merci parce que le salut est un cadeau de J√©sus. Aide-moi √† me souvenir que Tu m'aimes m√™me lorsque je me trompe. Et que mes bonnes actions n'ach√®tent pas Ton amour. Amen !‚Äù</p>
          `
        },
        girl: { 
          title: 'Jour 1 ‚Äî Le Cadeau Unique de Dieu', 
          html: `
            <h3>Verset Cl√©</h3>
            <p><strong>Galates 1:8-9 (LSG):</strong> ‚ÄúMais si nous-m√™mes, ou un ange du ciel, vous annon√ßait un √âvangile s‚Äô√©cartant de celui que nous vous avons annonc√©, qu‚Äôil soit anath√®me !‚Äù</p>
            <h3>R√©sum√©</h3>
            <p>Il n'y a qu'une seule nouvelle merveilleuse sur la fa√ßon dont nous devenons amies avec Dieu : le salut est un cadeau que J√©sus nous offre. Ce n'est pas une m√©daille pour celle qui fait tout correctement. C'est juste Sa gr√¢ce, un cadeau d'amour qui ne peut √™tre ni √©chang√©, ni compl√©t√©, ni am√©liorado.</p>
            <h3>Aplica√ß√£o Pr√°tica</h3>
            <p>Parfois, tu peux penser que tu dois √™tre parfaite, ne jamais te tromper ou toujours plaire √† tout le monde para que God t'ame. Mais l'amour de Jesus est j√° completo, telle que tu es. Tu peux te reposer sur cela : J√©sus a d√©j√† fait tout ce dont tu as besoin.</p>
            <h3>Pri√®re</h3>
            <p>‚ÄúCher Dieu, merci parce que le salut est un cadeau de J√©sus. Aide-moi √† me souvenir que Tu m'aimes m√™me lorsque je me trompe. Et que mes bonnes actions n'ach√®tent pas Ton amor. Amen !‚Äù</p>
          ` 
        },
        captions: { color: 'Don de Dieu', bw: 'Page √† colorier' },
        buttons: {
          printBoy: 'Imprimer le dessin (Gar√ßon)',
          printGirl: 'Imprimer le dessin (Fille)',
          coloring: 'üé® Colorier Num√©riquement',
          next: 'D√©votion suivante',
          boy: 'üë¶ Je suis un Gar√ßon',
          girl: 'üëß Je suis une Fille'
        },
        images: {
          boy: { color: BOY_COLOR_IMG, bw: BOY_BW_IMG }, 
          girl: { color: GIRL_COLOR_IMG, bw: GIRL_BW_IMG } 
        },
        print: { boy: BOY_PRINT_PDF, girl: GIRL_PRINT_PDF }
      }
    };

    // Helper para atualizar o conte√∫do e o tema visual, sem mexer no estado de "disabled" dos bot√µes de √°udio.
    function updateContent(langCode, gender) {
        const cfgLang = content[langCode];
        const cfg = cfgLang[gender];

        document.body.classList.remove('boy', 'girl');
        document.body.classList.add(gender);
        
        subtitleEl.textContent = cfg.title;
        devBox.innerHTML = cfg.html;

        imgColorSrc.src = cfgLang.images[gender].color;

        imgColorSrc.alt = gender === 'boy'
            ? (langCode === 'pt' ? 'Menino recebendo um presente colorido' :
            langCode === 'en' ? 'Boy receiving a colorful gift' :
            langCode === 'es' ? 'Ni√±o recibiendo um regalo colorido' :
            'Gar√ßon recevant un cadeau color√©')
            : (langCode === 'pt' ? 'Menina recebendo um presente colorido' :
            langCode === 'en' ? 'Girl receiving a colorful gift' :
            langCode === 'es' ? 'Ni√±a recibindo um regalo colorido' :
            'Fille recevant un cadeau color√©');

        captionColor.textContent = cfgLang.captions.color;
        
        printBtn.href = cfgLang.print[gender];
        printBtn.textContent = gender === 'boy' ? cfgLang.buttons.printBoy : cfgLang.buttons.printGirl;
        coloringBtn.textContent = cfgLang.buttons.coloring; 
    }

    // Dados das Bandeiras para o Bot√£o de Toggle
    const flagLanguageMap = {
        'pt': { src: 'https://flagicons.lipis.dev/flags/4x3/br.svg', alt: 'Bandeira do Brasil' },
        'en': { src: 'https://flagicons.lipis.dev/flags/4x3/us.svg', alt: 'US Flag' },
        'es': { src: 'https://flagicons.lipis.dev/flags/4x3/es.svg', alt: 'Bandera de Espa√±a' },
        'fr': { src: 'https://flagicons.lipis.dev/flags/4x3/fr.svg', alt: 'Drapeau de la France' }
    };

    // Idioma e g√™nero
    function setLang(lang) {
      currentLang = content[lang] ? lang : 'pt';
      const cfgLang = content[currentLang];
      const cfgHeader = cfgLang.header;

      const currentFlag = flagLanguageMap[currentLang];
      currentLangFlagEl.src = currentFlag.src;
      currentLangFlagEl.alt = currentFlag.alt;

      document.documentElement.lang = currentLang === 'pt' ? 'pt-BR' : currentLang;
      langSwitchEl.classList.remove('active');

      htmlTitleEl.textContent = cfgHeader.htmlTitle;
      mainTitleEl.textContent = cfgHeader.mainTitle;
      
      btnBoy.textContent = cfgLang.buttons.boy;
      btnGirl.textContent = cfgLang.buttons.girl;
      nextBtn.textContent = cfgLang.buttons.next;

      playBtn.textContent = narrator.isPlaying || narrator.isPaused ? (narrator.isPaused ? '‚ñ∂Ô∏è Continuar' : '‚è∏Ô∏è Pausar Devocional') : cfgHeader.play;
      stopBtn.textContent = cfgHeader.stop;
      
      const currentRate = speeds[speedIdx].toFixed(2);
      speedBtn.textContent = `${cfgHeader.speed}: ${currentRate}x`; 
      
      zoomBtn.textContent = `üîç Zoom: ${currentZoom.toFixed(1)}x`; 

      updateContent(currentLang, currentGender);
      // Se o modo colorir estiver ativo, reinicia ele para carregar a imagem correta (linguagem)
      if (isColoringMode) {
          initColoringMode();
      }
    }

    function setGender(gender) {
      // 1. Garante que o modo colorir esteja fechado ao mudar de g√™nero
      if(isColoringMode) toggleColoringMode(false);
      
      // 2. Comportamento de rolagem e oculta√ß√£o de t√≠tulo (mantido)
      mainHeader.classList.remove('scrolled-up'); 
      // devBox.style.display = 'none'; <--- MANTIDO FORA (o CSS j√° garante o display: none)

      currentGender = gender === 'girl' ? 'girl' : 'boy';
      
      document.body.classList.remove('neutral-hover'); 

      playBtn.removeAttribute('disabled');
      stopBtn.removeAttribute('disabled');
      speedBtn.removeAttribute('disabled'); 
      printBtn.removeAttribute('disabled');
      coloringBtn.removeAttribute('disabled'); 

      btnBoy.classList.remove('active-boy', 'active-girl');
      btnGirl.classList.remove('active-boy', 'active-girl');
      if (currentGender === 'boy') {
          btnBoy.classList.add('active-boy');
      } else {
          btnGirl.classList.add('active-girl');
      }

      imagesSection.style.display = 'flex';

      updateContent(currentLang, currentGender);

      narrator.stop();
      const header = content[currentLang].header;
      playBtn.textContent = header.play;
      
      const targetY = mainHeader.offsetTop; 
      if (window.scrollY !== targetY) {
          window.scrollTo({ top: targetY, behavior: 'smooth' });
          let lastScrollY = window.scrollY;
          function checkScrollEnd() {
            if (window.scrollY === lastScrollY || window.scrollY <= targetY) {
                mainHeader.classList.add('scrolled-up');
                window.scrollTo({ top: targetY, behavior: 'instant' }); 
                return;
            }
            lastScrollY = window.scrollY;
            window.requestAnimationFrame(checkScrollEnd);
          }
          window.requestAnimationFrame(checkScrollEnd);
      } else {
          mainHeader.classList.add('scrolled-up');
      }
    }

    // Narra√ß√£o ‚Äî Web Speech API (Mantido inalterado)
    const voicePrefs = {
      pt: { boy: ['Julio','Ricardo','Felipe'], girl: ['Francisca','Heloisa','Camila'] },
      en: { boy: ['Guy','Brian','Christopher'], girl: ['Aria','Jenny','Sarah'] },
      es: { boy: ['Alvaro','Jorge','Miguel'],   girl: ['Elvira','Lucia','Marta'] },
      fr: { boy: ['Henri','Paul','Philippe'],   girl: ['Denise','Celine','Amelie'] }
    };
    const localeMap = { pt: 'pt-BR', en: 'en-US', es: 'es-ES', fr: 'fr-FR' };
    let availableVoices = [];

    function voicesReady() {
      return new Promise(resolve => {
        const synth = window.speechSynthesis;
        let tries = 0;
        function check() {
          const voices = synth.getVoices();
          if (voices && voices.length > 0) {
            availableVoices = voices;
            resolve(voices);
          } else if (tries++ < 20) {
            setTimeout(check, 200);
          } else {
            availableVoices = voices || [];
            resolve(availableVoices);
          }
        }
        synth.onvoiceschanged = check;
        check();
      });
    }

    function pickVoice(langCode, gender) {
      const locale = localeMap[langCode] || 'pt-BR';
      const prefs = voicePrefs[langCode]?.[gender] || [];
      let v = availableVoices.find(x => x.lang === locale && prefs.some(n => x.name.toLowerCase().includes(n.toLowerCase())));
      if (v) return v;
      v = availableVoices.find(x => x.lang === locale);
      if (v) return v;
      v = availableVoices.find(x => (x.lang || '').toLowerCase().startsWith(langCode));
      if (v) return v;
      return availableVoices[0] || null;
    }

    class Narrator {
      constructor() {
        this.synth = window.speechSynthesis;
        this.rate = 0.95;
        this.pitchGirl = 1.3;
        this.pitchBoy = 1.2;
        this.voice = null;
        this.isPlaying = false;
        this.isPaused = false;
        this.text = '';
        this.langCode = 'pt';
        this.gender = 'boy';
      }

      async init(langCode, gender, text) {
        await voicesReady();
        this.voice = pickVoice(langCode, gender);
        this.langCode = langCode;
        this.gender = gender;
        this.text = text;
      }

      play() {
        if (!this.text) return;
        
        if (this.synth.speaking && this.isPaused) {
             this.synth.resume();
             this.isPaused = false;
             this.isPlaying = true;
             playBtn.textContent = '‚è∏Ô∏è Pausar Devocional';
             return;
        }

        this.isPlaying = true;
        this.isPaused = false;
        this.synth.cancel(); 
        const utter = new SpeechSynthesisUtterance(this.text);
        utter.lang = localeMap[this.langCode] || 'pt-BR';
        if (this.voice) utter.voice = this.voice;
        utter.rate = this.rate;
        utter.pitch = this.gender === 'girl' ? this.pitchGirl : this.pitchBoy;
        
        utter.onstart = () => {
             playBtn.textContent = '‚è∏Ô∏è Pausar Devocional';
        };
        utter.onend = () => {
             this.stop();
             const header = content[currentLang].header;
             playBtn.textContent = header.play;
             
             // Salva o progresso ao finalizar o √°udio
             saveProgress();
        };

        this.synth.speak(utter);
      }

      pause() {
        if (!this.isPlaying) return;
        this.isPaused = true;
        this.isPlaying = false;
        try { 
            this.synth.pause();
            playBtn.textContent = '‚ñ∂Ô∏è Continuar';
        } catch {}
      }

      stop() {
        this.isPlaying = false;
        this.isPaused = false;
        try { this.synth.cancel(); } catch {}
        const header = content[currentLang].header;
        playBtn.textContent = header.play;
      }

      setRate(rate) {
        this.rate = rate;
      }
    }

    const narrator = new Narrator();

    // Event Listeners (Mantidos inalterados)
    playBtn.addEventListener('click', async () => {
      // Garante que o modo colorir esteja fechado se tentarem dar play
      if(isColoringMode) toggleColoringMode(false);
      
      if (narrator.isPaused) {
        narrator.play(); 
        return;
      }

      if (narrator.isPlaying) {
        narrator.pause();
        return;
      }

      const text = (devBox.innerText || '').replace(/\s+/g, ' ').trim();
      if (!text) return;
      
      await narrator.init(currentLang, currentGender, text);
      narrator.play();
    });

    speedBtn.addEventListener('click', () => {
      speedIdx = (speedIdx + 1) % speeds.length;
      const rate = speeds[speedIdx];
      narrator.setRate(rate);
      
      const speedText = content[currentLang].header.speed;
      speedBtn.textContent = `${speedText}: ${rate.toFixed(2)}x`; 
      
      if (narrator.isPlaying) {
        narrator.stop();
        narrator.play();
      }
    });

    stopBtn.addEventListener('click', () => {
      narrator.stop();
    });

    // Inicializa√ß√£o
    currentLang = 'pt';
    currentGender = 'boy';

    // 1. Carrega a paleta de cores
    createColorPalette();

    // Verifica o progresso salvo e ajusta o link do "Pr√≥ximo Devocional" se necess√°rio.
    checkAndRedirect(); 

    // 2. Carrega o idioma (para os textos dos bot√µes e t√≠tulos)
    setLang('pt'); 

    // 3. Define o estado visual inicial (NEUTRO)
    
    // G√™neros: transparentes (sem classe 'active')
    btnBoy.classList.remove('active-boy', 'active-girl');
    btnGirl.classList.remove('active-boy', 'active-girl');
    
    // Tema: neutro para hover, mas mant√©m a cor padr√£o (boy) para a borda do header, etc.
    document.body.classList.remove('boy', 'girl'); 
    document.body.classList.add('boy'); 
    document.body.classList.add('neutral-hover'); 
    
    // Bot√µes de √Åudio/A√ß√£o desabilitados
    playBtn.setAttribute('disabled', 'disabled');
    stopBtn.setAttribute('disabled', 'disabled');
    speedBtn.setAttribute('disabled', 'disabled');
    printBtn.setAttribute('disabled', 'disabled'); 
    coloringBtn.setAttribute('disabled', 'disabled'); 
    
    // Imagem, Devocional e Modo Colorir ocultos
    imagesSection.style.display = 'none';
    devBox.style.display = 'none'; 
    coloringModeEl.classList.remove('active');
    
    mainHeader.classList.remove('scrolled-up');
    
    // Reseta o estado inicial do zoom
    zoomIdx = 0;
    currentZoom = zoomLevels[0];
    zoomBtn.textContent = `üîç Zoom: 1.0x`;

    // Garante que o √°udio pare ao recarregar ou sair da p√°gina.
    window.addEventListener('unload', () => {
        if (window.speechSynthesis) {
            window.speechSynthesis.cancel();
        }
    });

  </script>
</body>
</html>